# Data manipulation with `dplyr`

Let's talk about data manipulation.  We'll be using the `dplyr` package, which is part of `tidyverse` First, we need to load our packages & data. 

```{r tidyverse_workaround_a3, echo = FALSE, message = FALSE}
# This invisible block is a workaround for Travis CI not having the tidyverse meta-package; 
library(ggplot2)
library(dplyr)
library(readr)
library(tibble)
library(forcats)
library(cowplot)
theme_set(theme_cowplot())
lizards <- read_csv("example_data/anoles.csv") # See Appendix A if you don't have this data
# Capture View()
real_view = View
View = function(x,...) knitr::kable(head(x))
```
```{r load_anoles_a3, echo = TRUE, eval=FALSE}
library(tidyverse) 
library(cowplot)
theme_set(theme_cowplot())
lizards <- read_csv("example_data/anoles.csv") # See Appendix A if you don't have this data
```

## The Pipe (%>%)

The **pipe ( %>% )** operator strings functions together in a sequence.  It takes the result of the function on its left and makes it the first argument to the function on the right. Let's say you wanted to calculate the base-12 log of the mean of the square root of the absolute value of numbers between -50 and 50. The traditional way to write that would be:

```{r nopipe}
log(mean(sqrt(abs(-50:50))), base = 12)
```
This is rather difficult to read; it has a lot of nested parentheses, and you need to start from the inside and work your way out to see what's happening.  With the pipe, you could re-write it like this:

```{r with_pipe}
-50:50 %>% abs() %>% sqrt() %>% 
  mean() %>% log(base = 12)
```
Using pipes can make your code much clearer, and is quite helpful when creating a sequence of related transformations on data.

In RStudio, you can insert the pipe by pressing Ctrl+Shift+M.

## Adding/modifying columns (mutate)

The `mutate()` function creates a new column in a data frame. For example, the total length of a lizard is defined as its snout-vent length (SVL) plus it's tail length.  

```{r mutate1}
mutate(.data = lizards, total_length = SVL + Tail) %>% 
  View() # Use View to look at the results in RStudio
```

This uses the lizards data to create a new column, total_length. Within the mutate command, you can reference columns directly by their names (like you do for aes() in ggplot). Mutate can create multiple new columns in a single command.

```{r mutate2}
mutate(lizards, # generally, the .data argument is not named
       # All subsequent arguments refer to new columns
       total_length = SVL + Tail,
       rel_limb = Limb/SVL,
       log_total_length = log(total_length),
       # You can also change an existing column by saving something to its name
       Color_morph = paste(Color_morph, "morph") # add "morph" after each color
       ) %>% View()
```
Note that this doesn't modify the `lizards` dataset.  It creates a new data frame that has an additional column. You'll need to save it as a new variable to use it.

```{r mutate3}
lizards_full = lizards %>% # It's also traditional to pipe the data argument in
  mutate(total_length = SVL + Tail,
         rel_limb = Limb/SVL,
         log_total_length = log(total_length)) 
```

Tidyverse functions are designed to be piped together.  For example:

```{r mutate_plot}
lizards %>% 
  mutate(Total_length = SVL + Tail) %>% 
  ggplot(aes(x = Site, y = Total_length)) +
  geom_boxplot()
```

Creating a quick plot at the end of a data manipulation step can be a good way to get a visual idea of what you're doing.  

Here are a few other helpful things to do with `mutate()`:

```{r mutate4, collect = TRUE}
lizards %>% mutate(
  intercept = 1, # Add a constant
  row_number = 1:n() # the n() function tells you how many rows are 
    # in the current data frame (it only works in mutate & related functions)
) %>%  View()
```


Here are a few exercises to try:

 1. Add a column to the `lizards` dataset that gives the lizard's height relative to the maximum height of any lizard (hint: use max(Height) in a mutate command to find that value).  
 2. Calculate perch circumference `(Diameter * pi)`, then pipe that result into a scatter plot of relative limb length vs. circumference. Note that `pi` is a pre-defined variable in R.

## Subsetting by row (filter)

Let's define "large lizards" as:

```{r mutate_large}
lizards %>% 
  mutate(large = SVL > 60) %>% 
  View()
```

The **large** column is a logical vector, with `TRUE` & `FALSE` values.  We can use logical vectors to get a subset of the data frame where the vector is `TRUE` with the `filter()` function.

```{r filter_intro}
lizards %>%
  mutate(large = SVL > 60) %>% 
  filter(large) %>% 
  View()
```

Note that only `TRUE` values of **large** remain the the data frame. It's not actually necessary to create a column before filtering:

```{r filter_2}
lizards %>% filter(SVL > 60) %>% View()
```

The `filter()` command returns every row where its logical conditions are `TRUE`.  Conditional statements that create logical statements include the following:

 - `x == y`: TRUE if x equals y (This is not the same as `x = y`)!
 - `x != y`: TRUE if x does not equal y
 - `x > y`: x >= y; 
 - `x < y`: x <= y; 
 - `between(x, y, z)`: TRUE if x >= y AND x <= z
 - `is.na(x)`: TRUE if x is a missing value (NA)
 - `x %in% y`: TRUE if x is an element in y

Note that all of these (except for `x %in% y`) are vectorized.

```{r conditional_vectorized, collapse = TRUE}
c(1, 2) == c(2, 3) - 1
c(1, 2, 3) == c(1, 4, 9)
c(1, 2) == c(2, 1) # positions don't match
c(1, 2, 3, 4, 5) %in% c(1, 2) # for %in%, position only matters for the left argument
```

You can also combine and modify logical values:

 - `x & y`: returns TRUE if both x and y are TRUE
 - `x | y`: returns TRUE if either x or y are TRUE
 - `!x`: returns the opposite of x; this one is particularly useful to combine with other logical functions; for example `filter(data, !is.na(x))` will return all rows where `x` is not a missing value.

If you give `filter()` more than one condition, it applies all of them by combining them with `&`.

```{r filter3}
lizards %>% 
  filter(Color_morph == "Blue",
         Site %in% c("A", "B", "C", "D", "E")) %>% 
  ggplot(aes(x = SVL, y = Height, color = Site)) + geom_point()
```

Exercises:

 3. Print a dataframe that shows only the lizards higher than 150 cm. How many are there (the console printout should tell you).
 4. How many lizards perching on trees or shrubs are not brown? Visualize the height to diameter relationship between them. Hint: you can use either `%in%` or a combination of `==` and `|` to meet the first condition.
 
## Subsetting by column (select)






## Grouping & summarizing data